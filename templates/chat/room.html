<!DOCTYPE html>
{% load static %}
<html>
<head>
<title>Chat Room {{ room_name }}</title>
<link rel="shortcut icon" href="{% static 'image/icon.ico' %}">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
* {
    box-sizing: border-box;
}

/* body æ ·å¼ */
body {
    font-family: Arial;
    margin: 0;
}

/* æ ‡é¢˜ */
.header {
    padding: 80px;
    text-align: center;
    background: lightblue;
    color: white;
}

/* æ ‡é¢˜å­—ä½“åŠ å¤§ */
.header h1 {
    font-size: 40px;
}

/* å¯¼èˆª */
.navbar {
    overflow: hidden;
    background-color: #333;
}

/* å¯¼èˆªæ æ ·å¼ */
.navbar a {
    float: left;
    display: block;
    color: white;
    text-align: center;
    padding: 14px 20px;
    text-decoration: none;
}

/* å³ä¾§é“¾æ¥*/
.navbar a.right {
    float: right;
}

/* é¼ æ ‡ç§»åŠ¨åˆ°é“¾æ¥çš„é¢œè‰² */
.navbar a:hover {
    background-color: #ddd;
    color: black;
}

/* åˆ—å®¹å™¨ */
.row {
    display: -ms-flexbox; /* IE10 */
    display: flex;
    -ms-flex-wrap: wrap; /* IE10 */
    flex-wrap: wrap;
}

/* ä¸»è¦çš„å†…å®¹åŒºåŸŸ */
.main {
    -ms-flex: 70%; /* IE10 */
    flex: 70%;
    text-align: center;
    background-image: url({% static 'image/babara.jpeg' %});
    padding: 20px;
}

.log {
    opacity: 0.6;
    width: 800px;
    border: 1px solid;
    background-color: white;
    margin: auto;
    height: 400px;
    overflow: scroll;
}

.leftt {
    text-align: left;
    background-color: #5b80b2;
    height: auto;
    width: auto;
    min-width: 50px;
    border-radius: 5px;
}

.leftt::after{
            content: '';
            width: 0;
            height: 0;
            border: 10px solid;
            border-color: transparent transparent #5b80b2 transparent;
            position: relative;
            top:-25px;
            left:-10px;
            z-index: -1;
        }

.leftl {
    text-align: left;
    height: auto;
}

.rightt {
    text-align: right;
    background-color: #81d4fa;
    height: auto;
    width: auto;
    min-width: 50px;
    border-radius: 5px;
}

.rightl {
    text-align: right;
    height: auto;
}

.rightt::after{
    content: '';
    width: 0;
    height: 0;
    border: 10px solid;
    border-color: transparent transparent #81d4fa transparent;
    position: relative;
    top:-25px;
    left:-30px;
    z-index: -1;
    }

.redt {
    text-align: left;
    color: red;
}

/* åº•éƒ¨ */
.footer {
    padding: 20px;
    text-align: center;
    background: #ddd;
}

/* å“åº”å¼å¸ƒå±€ - åœ¨å±å¹•è®¾å¤‡å®½åº¦å°ºå¯¸å°äº 700px æ—¶, è®©ä¸¤æ ä¸Šä¸‹å †å æ˜¾ç¤º */
@media screen and (max-width: 700px) {
    .row {
        flex-direction: column;
    }
}

/* å“åº”å¼å¸ƒå±€ - åœ¨å±å¹•è®¾å¤‡å®½åº¦å°ºå¯¸å°äº 400px æ—¶, è®©å¯¼èˆªæ ç›®ä¸Šä¸‹å †å æ˜¾ç¤º */
@media screen and (max-width: 400px) {
    .navbar a {
        float: none;
        width: 100%;
    }
}
</style>
<script>
    function getImgName(username, dic) {
        for (let i = 0; i < dic.length; i++) {
            if (dic[i].pk === username) {
                return dic[i].fields.img;
            }
        }
        return 'images/default.jpg';
    }
    function clearInput() {
        let line = document.getElementById("chat-log");
        line.innerHTML = '';
    }
    function addEmoji() {
        let line = document.getElementById("input");
        let emoji = document.getElementById("emoji");
        line.value += emoji.value;
    }
</script>
</head>
 <body>
 <div class="header">
  <h1><img src="{% static 'image/weichat.jpg' %}" width="80px" height="80px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {{ ver }}-{{ room_name }} Chat Room</h1>
  <p>Welcome to {{ room_name }} Chat Room</p>
</div>

<div class="navbar">
  <a href="/chat">Rechoose Chat Room</a>
  <a href="/" class="right">Back to Main Page</a>
</div>
 <div class="row">
  <div class="main">
     <div class="log" id="chat-log"></div><br/>
     <input id="input" type="text" size="100" style="opacity: 0.6"> &nbsp;&nbsp;
      <select id="emoji" onchange="addEmoji()">
          <option>ğŸ˜€</option>
          <option>ğŸ˜„</option>
          <option>ğŸ˜</option>
          <option>ğŸ˜†</option>
          <option>ğŸ˜…</option>
          <option>ğŸ˜‚</option>
          <option>ğŸ™‚</option>
          <option>ğŸ˜</option>
          <option>ğŸ˜˜</option>
          <option>ğŸ˜‹</option>
          <option>ğŸ˜</option>
          <option>ğŸ˜Ÿ</option>
          <option>ğŸ˜¡</option>
          <option>ğŸ˜±</option>
          <option>ğŸ˜®</option>
          <option>ğŸ˜­</option>
          <option>ğŸ˜µ</option>
      </select><br/>
     <input id="submit" type="button" value="Send">&nbsp;&nbsp;
      <input type="button" value="Reset" onclick="clearInput()">&nbsp;&nbsp;&nbsp;&nbsp;
{#      <input id="img" type="file" style="display: none">#}
{#      <input type="button" value="Send Image" onclick="document.getElementById('img').click()">#}
  </div>
</div>
<script>
        // è·å–æˆ¿é—´å
        const roomName = '{{ room_name }}';

        // æ ¹æ®roomNameæ‹¼æ¥websocketè¯·æ±‚åœ°å€ï¼Œå»ºç«‹é•¿è¿æ¥
        // è¯·æ±‚urlåœ°å€ä¸º/ws/chat/<room_name>/
        const wss_protocol = (window.location.protocol === 'https:') ? 'wss://': 'ws://';
        const chatSocket = new WebSocket(
             wss_protocol + window.location.host + '/ws/chat/'  + roomName + '/'
            );

        // å»ºç«‹websocketè¿æ¥æ—¶è§¦å‘æ­¤æ–¹æ³•ï¼Œå±•ç¤ºæ¬¢è¿æç¤º
        chatSocket.onopen = function(e) {
            const welcome_word = '[Broadcast]' + '{{ user }}' + ' join the chat';
            chatSocket.send(JSON.stringify({
                 'message': welcome_word,
                 'user': 'Broadcast'
            }));
            document.querySelector('#chat-log').innerHTML += ('<div class="redt">[Info]Welcome to ' + roomName + ' chat room!</div><br/>')
        }

        // ä»åå°æ¥æ”¶åˆ°æ•°æ®æ—¶è§¦å‘æ­¤æ–¹æ³•
        // æ¥æ”¶åˆ°åå°æ•°æ®åå¯¹å…¶è§£æï¼Œå¹¶åŠ å…¥åˆ°èŠå¤©è®°å½•chat-log
         chatSocket.onmessage = function(e) {
             const data = JSON.parse(e.data);
             var dic = JSON.parse('{{ imgdic | safe }}')

             if (data["user"] === 'Broadcast') {
                 document.querySelector('#chat-log').innerHTML += ('<div class="redt">' + data["date"] + '-' + data["message"] + '</div><br/>');
             } else if (data["user"] === '{{ user }}') {
                 let imgName = getImgName(data["user"], dic);
                 document.querySelector('#chat-log').innerHTML += ('<div class="rightl">' + data["date"] + '-' + data["user"] + '<img src="/media/' + imgName + '" width="20px"></div>')
                 document.querySelector('#chat-log').innerHTML += ('<div class="rightt">' + data["message"] + '</div><br/>');
             } else {
                 let imgName = getImgName(data["user"], dic);
                 document.querySelector('#chat-log').innerHTML += ('<div class="leftl">' + data["date"] + '-' + data["user"] + '<img src="/media/' + imgName + '" width="20px"></div>')
                 document.querySelector('#chat-log').innerHTML += ('<div class="leftt">' +  data["message"] + '</div><br/>');
             }
        };

         // websocketè¿æ¥æ–­å¼€æ—¶è§¦å‘æ­¤æ–¹æ³•
         chatSocket.onclose = function(e) {
            const leave_word = '[Broadcast]' + '{{ user }}' + ' leave the chat';
            chatSocket.send(JSON.stringify({
                 'message': leave_word,
                 'user': 'Broadcast'
            }));
             console.error('Chat socket closed unexpectedly');
        };

         document.querySelector('#input').focus();
         document.querySelector('#input').onkeyup = function(e) {
             if (e.keyCode === 13) {  // enter, return
                 document.querySelector('#submit').click();
            }
        };

         // æ¯å½“ç‚¹å‡»å‘é€æ¶ˆæ¯æŒ‰é’®ï¼Œé€šè¿‡websocketçš„sendæ–¹æ³•å‘åå°å‘é€ä¿¡æ¯ã€‚
         document.querySelector('#submit').onclick = function(e) {
             const messageInputDom = document.querySelector('#input');
             const message = messageInputDom.value;

             //æ³¨æ„è¿™é‡Œ:å…ˆæŠŠæ–‡æœ¬æ•°æ®è½¬æˆjsonæ ¼å¼,ç„¶åè°ƒç”¨sendæ–¹æ³•å‘é€ã€‚
             chatSocket.send(JSON.stringify({
                 'message': message,
                 'user': '{{ user }}',
            }));
             messageInputDom.value = '';
        };

         {#document.querySelector('#img').onchange = function(e) {#}
         {#    var file = e.target.files[0];#}
         {#    console.log(file)#}
         {#    fileUpload(file)#}
         {#    chatSocket.send(JSON.stringify({#}
         {#        'message': '<img src="/media/tmpimg/' + file.name + '" width="60px">',#}
         {#        'user': '{{ user }}',#}
         {#   }));#}
         {#    console.log('<img src="/media/tmpimg/' + file + '" width="60px">')#}
         //}
</script>

<div class="footer">
  <h2>
      powered by elepikachu
  </h2>
</div>

</body>
</html>